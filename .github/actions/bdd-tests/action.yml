name: 'Run BDD Tests'
description: 'Runs Cucumber BDD smoke tests using Playwright'

inputs:
  test-type:
    description: 'Type of tests to run (smoke, all, debug)'
    required: false
    default: 'smoke'

runs:
  using: 'composite'
  steps:
    - name: Install Playwright Browsers
      shell: bash
      run: |
        echo "üì¶ Installing Playwright browsers..."
        pnpm exec playwright install --with-deps chromium

    - name: Start development server
      shell: bash
      run: |
        echo "üöÄ Starting Next.js development server..."
        pnpm run dev &
        
        # Wait for server to be ready
        echo "‚è≥ Waiting for server to start..."
        timeout 60 bash -c 'until curl -s http://localhost:3000 > /dev/null; do sleep 1; done' || {
          echo "‚ùå Server failed to start within 60 seconds"
          exit 1
        }
        
        echo "‚úÖ Server is ready at http://localhost:3000"

    - name: Run BDD tests
      shell: bash
      run: |
        echo "ü•í Running Cucumber BDD tests (type: ${{ inputs.test-type }})"

        case "${{ inputs.test-type }}" in
          smoke)
            echo "Running smoke tests..."
            pnpm test:cucumber:smoke
            ;;
          all)
            echo "Running all tests..."
            pnpm test:cucumber
            ;;
          debug)
            echo "Running tests in debug mode..."
            pnpm test:cucumber:debug
            ;;
          *)
            echo "‚ö†Ô∏è  Unknown test type '${{ inputs.test-type }}', defaulting to smoke"
            pnpm test:cucumber:smoke
            ;;
        esac

        echo "‚úÖ BDD tests completed successfully"
